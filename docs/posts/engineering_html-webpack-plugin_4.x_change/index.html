<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复 | GeekHouse</title>
<meta name=keywords content="Engineering">
<meta name=description content="前言 手上的公司项目热重载一直很慢，每次热重载大概要 15s 左右，最近实在忍无可忍，决定排查一下。
猜想 项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在超过 30 个模板。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 解决了问题，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？
升级 html-webpack-plugin 问题解决 我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度降到了 1s 左右！
问题解决了，可是其中的原理是什么呢？
使用 cpuprofile-webpack-plugin 进行性能分析 cpuprofile-webpack-plugin 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的火焰图，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：
 图：cpuprofile-webpack-plugin 分析结果
 我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 13.51s，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：
 图：一次时间较长的 html-webpack-plugin 运行
 点击进去，查看更详细的调用栈分析：
 图：html-webpack-plugin 详细的调用栈分析
 发现全部耗时集中在 html-webpack-plugin/index.js -> templateParametersGenerator -> toJson 函数上。
查看源码 首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并没有调用 toJson 方法：">
<meta name=author content="YYJ">
<link rel=canonical href=https://geekhouse.top/posts/engineering_html-webpack-plugin_4.x_change/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.83c4eb6d61e6a4176992e4a4ce8786fc30bd40032ba8663ec5d11e285a965766.css integrity="sha256-g8TrbWHmpBdpkuSkzoeG/DC9QAMrqGY+xdEeKFqWV2Y=" rel="preload stylesheet" as=style>
<link rel=icon href=https://geekhouse.top/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://geekhouse.top/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://geekhouse.top/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://geekhouse.top/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://geekhouse.top/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-184187677-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复">
<meta property="og:description" content="前言 手上的公司项目热重载一直很慢，每次热重载大概要 15s 左右，最近实在忍无可忍，决定排查一下。
猜想 项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在超过 30 个模板。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 解决了问题，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？
升级 html-webpack-plugin 问题解决 我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度降到了 1s 左右！
问题解决了，可是其中的原理是什么呢？
使用 cpuprofile-webpack-plugin 进行性能分析 cpuprofile-webpack-plugin 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的火焰图，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：
 图：cpuprofile-webpack-plugin 分析结果
 我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 13.51s，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：
 图：一次时间较长的 html-webpack-plugin 运行
 点击进去，查看更详细的调用栈分析：
 图：html-webpack-plugin 详细的调用栈分析
 发现全部耗时集中在 html-webpack-plugin/index.js -> templateParametersGenerator -> toJson 函数上。
查看源码 首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并没有调用 toJson 方法：">
<meta property="og:type" content="article">
<meta property="og:url" content="https://geekhouse.top/posts/engineering_html-webpack-plugin_4.x_change/"><meta property="og:image" content="https://geekhouse.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-10-11T00:00:00+00:00">
<meta property="article:modified_time" content="2019-10-11T00:00:00+00:00"><meta property="og:site_name" content="ExampleSite">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://geekhouse.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复">
<meta name=twitter:description content="前言 手上的公司项目热重载一直很慢，每次热重载大概要 15s 左右，最近实在忍无可忍，决定排查一下。
猜想 项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在超过 30 个模板。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 解决了问题，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？
升级 html-webpack-plugin 问题解决 我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度降到了 1s 左右！
问题解决了，可是其中的原理是什么呢？
使用 cpuprofile-webpack-plugin 进行性能分析 cpuprofile-webpack-plugin 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的火焰图，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：
 图：cpuprofile-webpack-plugin 分析结果
 我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 13.51s，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：
 图：一次时间较长的 html-webpack-plugin 运行
 点击进去，查看更详细的调用栈分析：
 图：html-webpack-plugin 详细的调用栈分析
 发现全部耗时集中在 html-webpack-plugin/index.js -> templateParametersGenerator -> toJson 函数上。
查看源码 首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并没有调用 toJson 方法：">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://geekhouse.top/posts/"},{"@type":"ListItem","position":2,"name":"html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复","item":"https://geekhouse.top/posts/engineering_html-webpack-plugin_4.x_change/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复","name":"html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复","description":"前言 手上的公司项目热重载一直很慢，每次热重载大概要 15s 左右，最近实在忍无可忍，决定排查一下。\n猜想 项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在超过 30 个模板。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 解决了问题，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？\n升级 html-webpack-plugin 问题解决 我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度降到了 1s 左右！\n问题解决了，可是其中的原理是什么呢？\n使用 cpuprofile-webpack-plugin 进行性能分析 cpuprofile-webpack-plugin 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的火焰图，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：\n 图：cpuprofile-webpack-plugin 分析结果\n 我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 13.51s，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：\n 图：一次时间较长的 html-webpack-plugin 运行\n 点击进去，查看更详细的调用栈分析：\n 图：html-webpack-plugin 详细的调用栈分析\n 发现全部耗时集中在 html-webpack-plugin/index.js -\u0026gt; templateParametersGenerator -\u0026gt; toJson 函数上。\n查看源码 首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并没有调用 toJson 方法：","keywords":["Engineering"],"articleBody":"前言 手上的公司项目热重载一直很慢，每次热重载大概要 15s 左右，最近实在忍无可忍，决定排查一下。\n猜想 项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在超过 30 个模板。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 解决了问题，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？\n升级 html-webpack-plugin 问题解决 我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度降到了 1s 左右！\n问题解决了，可是其中的原理是什么呢？\n使用 cpuprofile-webpack-plugin 进行性能分析 cpuprofile-webpack-plugin 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的火焰图，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：\n 图：cpuprofile-webpack-plugin 分析结果\n 我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 13.51s，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：\n 图：一次时间较长的 html-webpack-plugin 运行\n 点击进去，查看更详细的调用栈分析：\n 图：html-webpack-plugin 详细的调用栈分析\n 发现全部耗时集中在 html-webpack-plugin/index.js - templateParametersGenerator - toJson 函数上。\n查看源码 首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并没有调用 toJson 方法：\n 图：4.0.0-beta.8 templateParametersGenerator 的调用\n  图：4.0.0-beta.8 templateParametersGenerator 的定义\n 然后回溯 3.2.0 版本之前的提交，终于见到了它的调用，webpack 文档中解释 compilation.getStats().toJson() 是用来生成编译过程的性能分析 json 文件的方法，那么罪魁祸首就是它了。\n 图：3.2.0 templateParametersGenerator 的定义\n 查找修复这个问题的 commit 后来我尝试了把 html-webpack-plugin 的版本回退到 4.x 的第一个版本 4.0.0-alpha，发现热重载性能依然是没问题的，因此提交的定位就在 3.2.0 到 4.0.0-alpha 之间，经过一番查找，终于找到了这个 fix，出于性能原因移除 compilation.getStats()：\n 图：fix: Remove compilation.getStats() call for performance reasons\n 后记 其实这次排查我也走了不少弯路，之前一直在尝试通过阅读代码查找，找了一天都找不出来，后来使用了性能分析工具才知道自己之前有多蠢 :-)。本文只是给大家讲一个性能分析的故事，为大家提供一些思路，希望大家的代码都没有bug~\n附：html-webpack-plugin 4.x 钩子函数的变更 由于我的代码里踩了这个坑，所以给大家讲一下，html-webpack-plugin 4.x 对钩子函数进行了重构，注意是重构，不是更新，也就是说，虽然名字改了，但是所有功能都是没有变化且一一对应的，作者的 commit 里使用的 badge 也是 refactor：\n 图：钩子函数重构的 commit\n  图：3.x 钩子函数文档\n  图：4.x 钩子函数文档\n  图：4.x 钩子函数文档\n ","wordCount":"130","inLanguage":"en","datePublished":"2019-10-11T00:00:00Z","dateModified":"2019-10-11T00:00:00Z","author":{"@type":"Person","name":"YYJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://geekhouse.top/posts/engineering_html-webpack-plugin_4.x_change/"},"publisher":{"@type":"Organization","name":"GeekHouse","logo":{"@type":"ImageObject","url":"https://geekhouse.top/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://geekhouse.top/ accesskey=h title="GeekHouse (Alt + H)">GeekHouse</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://geekhouse.top/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://geekhouse.top/timeline/ title=Timeline>
<span>Timeline</span>
</a>
</li>
<li>
<a href=https://geekhouse.top/about/ title=About>
<span>About</span>
</a>
</li>
<li>
<a href=https://geekhouse.top/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[['$','$']],displayMath:[['$$','$$']],processEscapes:!0,processEnvironments:!0,skipTags:['script','noscript','style','textarea','pre'],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var b=MathJax.Hub.getAllJax(),a;for(a=0;a<b.length;a+=1)b[a].SourceElement().parentNode.className+=' has-jax'})</script>
<style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
html-webpack-plugin 4.x 对多模板下热重载缓慢问题的修复
</h1>
<div class=post-meta>October 11, 2019&nbsp;·&nbsp;1 min&nbsp;·&nbsp;YYJ&nbsp;|&nbsp;<a href=https://github.com/yyj08070631.github.io/content/posts/engineering_html-webpack-plugin_4.x_change/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2>
<p>手上的公司项目热重载一直很慢，每次热重载大概要 <code>15s</code> 左右，最近实在忍无可忍，决定排查一下。</p>
<h2 id=猜想>猜想<a hidden class=anchor aria-hidden=true href=#猜想>#</a></h2>
<p>项目是基于 vue-cli2 搭建的，前人将 webpack 升级到了 webpack4。出于历史原因，公司项目的模块是根据模板（.html）划分的，因此项目中存在<code>超过 30 个模板</code>。这让我想起了之前在优化一个 webpack3 项目的时候，也遇到过类似的多模板热重载缓慢的情况，当时是使用 html-webpack-plugin-for-multihtml 库 <a href=https://juejin.im/post/6844903813346770958#heading-14 target=_blank>解决了问题</a>，因此我想，这次会不会也是 html-webpack-plugin 的锅呢？</p>
<h2 id=升级-html-webpack-plugin-问题解决>升级 html-webpack-plugin 问题解决<a hidden class=anchor aria-hidden=true href=#升级-html-webpack-plugin-问题解决>#</a></h2>
<p>我尝试把 html-webpack-plugin 升级到了最新的 @4.0.0-beta.8 版本，发现热重载速度<code>降到了 1s</code> 左右！</p>
<p>问题解决了，可是其中的原理是什么呢？</p>
<h2 id=使用-cpuprofile-webpack-plugin-进行性能分析>使用 cpuprofile-webpack-plugin 进行性能分析<a hidden class=anchor aria-hidden=true href=#使用-cpuprofile-webpack-plugin-进行性能分析>#</a></h2>
<p><a href=https://npmjs.com/package/cpuprofile-webpack-plugin target=_blank>cpuprofile-webpack-plugin</a> 是一个图形化的 webpack 构建性能分析工具，它会统计构建过程中每个插件运行的时间，还会生成整个构建过程的<a href=https://github.com/brendangregg/FlameGraph target=_blank>火焰图</a>，如下图，它记录了我的项目使用 html-webpack-plugin@3.2.0 时一次热重载的性能分析：</p>
<p><img loading=lazy src=16db9fa2efb02b2d~tplv-t2oaga2asx-image-20211014205338231.image alt="一次时间较长的 html-webpack-plugin 运行">
</p>
<blockquote>
<p>图：cpuprofile-webpack-plugin 分析结果</p>
</blockquote>
<p>我们发现在整个 15.94s 的热重载过程中，html-webpack-plugin 的运行时间占据了 <code>13.51s</code>，可以说几乎全部时间都用在了这上面，这个图也验证了我的猜想。接下来，我们通过火焰图进一步分析，首先找一个运行时间较长，比较有代表性的 html-webpack-plugin 执行过程：</p>
<p><img loading=lazy src=16db9fa2efb02b2d~tplv-t2oaga2asx-image-20211014205410815.image alt="一次时间较长的 html-webpack-plugin 运行">
</p>
<blockquote>
<p>图：一次时间较长的 html-webpack-plugin 运行</p>
</blockquote>
<p>点击进去，查看更详细的调用栈分析：</p>
<p><img loading=lazy src=16db9fc2b8dc19d2~tplv-t2oaga2asx-image-20211014205425577.image alt="html-webpack-plugin 详细的调用栈分析">
</p>
<blockquote>
<p>图：html-webpack-plugin 详细的调用栈分析</p>
</blockquote>
<p>发现全部耗时集中在 html-webpack-plugin/index.js -> templateParametersGenerator -> toJson 函数上。</p>
<h2 id=查看源码>查看源码<a hidden class=anchor aria-hidden=true href=#查看源码>#</a></h2>
<p>首先查看了最新版（4.0.0-beta.8）中 templateParametersGenerator 方法的源码，可以看出它是用来生成 templateParameters 的默认配置的，而在这个版本中它并<code>没有调用 toJson 方法</code>：</p>
<p><img loading=lazy src=16dba046399214ad~tplv-t2oaga2asx-image-20211014205531379.image alt="4.0.0-beta.8 templateParametersGenerator 的调用">
</p>
<blockquote>
<p>图：4.0.0-beta.8 templateParametersGenerator 的调用</p>
</blockquote>
<p><img loading=lazy src=16dba05bf5cf49b7~tplv-t2oaga2asx-image-20211014205542057.image alt="4.0.0-beta.8 templateParametersGenerator 的定义">
</p>
<blockquote>
<p>图：4.0.0-beta.8 templateParametersGenerator 的定义</p>
</blockquote>
<p>然后回溯 3.2.0 版本之前的提交，终于见到了它的调用，webpack 文档中解释 compilation.getStats().toJson() 是用来生成编译过程的性能分析 json 文件的方法，那么罪魁祸首就是它了。</p>
<p><img loading=lazy src=16dba1e46f95607c~tplv-t2oaga2asx-image-20211014205553136.image alt="3.2.0 templateParametersGenerator 的定义">
</p>
<blockquote>
<p>图：3.2.0 templateParametersGenerator 的定义</p>
</blockquote>
<h2 id=查找修复这个问题的-commit>查找修复这个问题的 commit<a hidden class=anchor aria-hidden=true href=#查找修复这个问题的-commit>#</a></h2>
<p>后来我尝试了把 html-webpack-plugin 的版本回退到 4.x 的第一个版本 4.0.0-alpha，发现热重载性能依然是没问题的，因此提交的定位就在 3.2.0 到 4.0.0-alpha 之间，经过一番查找，终于找到了这个 fix，<code>出于性能原因移除 compilation.getStats()</code>：</p>
<p><img loading=lazy src=16dba2a456d26068~tplv-t2oaga2asx-image-20211014205606393.image alt="fix: Remove compilation.getStats() call for performance reasons">
</p>
<blockquote>
<p>图：fix: Remove compilation.getStats() call for performance reasons</p>
</blockquote>
<h2 id=后记>后记<a hidden class=anchor aria-hidden=true href=#后记>#</a></h2>
<p>其实这次排查我也走了不少弯路，之前一直在尝试通过阅读代码查找，找了一天都找不出来，后来使用了性能分析工具才知道自己之前有多蠢 :-)。本文只是给大家讲一个性能分析的故事，为大家提供一些思路，希望大家的代码都没有bug~</p>
<h2 id=附html-webpack-plugin-4x-钩子函数的变更>附：html-webpack-plugin 4.x 钩子函数的变更<a hidden class=anchor aria-hidden=true href=#附html-webpack-plugin-4x-钩子函数的变更>#</a></h2>
<p>由于我的代码里踩了这个坑，所以给大家讲一下，html-webpack-plugin 4.x 对钩子函数进行了<code>重构</code>，注意是重构，不是更新，也就是说，虽然名字改了，但是所有功能都是没有变化且一一对应的，作者的 commit 里使用的 badge 也是 <code>refactor</code>：</p>
<p><img loading=lazy src=16dba3a6c29b23dc~tplv-t2oaga2asx-image-20211014205624117.image alt="钩子函数重构的 commit">
</p>
<blockquote>
<p>图：钩子函数重构的 commit</p>
</blockquote>
<p><img loading=lazy src=16dab7d60edee4a2~tplv-t2oaga2asx-image-20211014205635816.image alt="3.x 钩子函数文档">
</p>
<blockquote>
<p>图：3.x 钩子函数文档</p>
</blockquote>
<p><img loading=lazy src=16dab819add657e0~tplv-t2oaga2asx-image-20211014205709220.image alt="4.x 钩子函数文档">
</p>
<blockquote>
<p>图：4.x 钩子函数文档</p>
</blockquote>
<p><img loading=lazy src=16dab8208657e6bc~tplv-t2oaga2asx-image-20211014205718298.image alt="4.x 钩子函数文档">
</p>
<blockquote>
<p>图：4.x 钩子函数文档</p>
</blockquote>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://geekhouse.top/tags/engineering/>Engineering</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://geekhouse.top/posts/algorithm_bit/>
<span class=title>« Prev Page</span>
<br>
<span>位运算的算法应用</span>
</a>
<a class=next href=https://geekhouse.top/posts/algorithm_sort/>
<span class=title>Next Page »</span>
<br>
<span>排序算法</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://geekhouse.top/>GeekHouse</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>